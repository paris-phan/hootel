{% extends 'base.html' %}
{% load static %}

{% block title %}{{ collection.title }} - Collection{% endblock %}

{% block extra_css %}
<style>
/* Custom modal styles */
.custom-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 2000;
}

.custom-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border-radius: 5px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    width: 80%;
    max-width: 800px;
    z-index: 2001;
}

.custom-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
}

.custom-modal-title {
    margin: 0;
    font-size: 1.25rem;
}

.custom-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    margin-left: 15px;
}

.custom-modal-body {
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
}

.custom-modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Search Bar Styles */
.search-bar {
    max-width: 500px;
    margin: 0;
}

.search-bar input {
    padding: 0.75rem 1rem;
    border: none;
    border-bottom: 1px solid #dad9d7;
    border-radius: 0;
    font-size: 1rem;
    width: 100%;
    background: transparent;
}

.search-bar input:focus {
    outline: none;
    border-color: #9D5248;
}


/* Selected Collection Info styles */
.selected-collection-info {
    max-width: 800px;
    margin: 2rem 0;
    padding: 1.5rem;
    background-color: #F7F5F1;
    border-left: 3px solid #9D5248;
}

.selected-collection-info h3 {
    color: #9D5248;
    margin-bottom: 0.5rem;
}

.selected-collection-info p {
    margin-bottom: 0;
    line-height: 1.6;
}




.destinations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 3rem;
}

/* Card Styles */
.slider-card {
    height: 100%;
}

.slider-card .card {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.slider-card .media--responsive {
    height: 250px;
    overflow: hidden;
}

.slider-card .media--responsive img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.slider-card .media--responsive img:hover {
    transform: scale(1.05);
}

.slider-card figcaption {
    flex: 1;
    padding: 1rem;
}

.slider-card figcaption p {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 1rem;
}

.slider-card .card__post-link-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background-color: var(--color-background);
    border-top: 1px solid var(--color-border);
}

.card__link__cta {
    color: var(--color-text);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
}

.card__link__cta:hover {
    color: var(--color-primary);
}

.card__post-link-content p {
    margin: 0;
    color: var(--color-text);
    font-weight: 500;
}

</style>
{% endblock %}

{% block content %}
<!-- Intro Section -->
<section class="container container--spacer gutter">
    <header class="hgroup hgroup--limited text--centered">
      <p class="subtitle">Influential Collections</p>
      <h2 class="heading-h">{{ collection.title }}</h2>
      <div class="hgroup__intro">
        
        <p>Curated By: {{ collection.creator.username }}</p>
      </div>
    </header>

    <!-- Selected Collection Info -->
    <div id="selected-collection-info" class="selected-collection-info mb-4">
        <p>{{ collection.description }}</p>

        <div class="d-flex align-items-center text-muted mb-3">
            <small>
                Created by <a href="{% url 'accounts:user_profile' username=collection.creator.username %}" class="text-decoration-none">{{ collection.creator.username }}</a>
                on {{ collection.created_at|date:"F j, Y" }}
            </small>
        </div>

        <span class="badge {% if collection.visibility == 0 %}bg-success{% else %}bg-warning{% endif %} mb-3">
            {{ collection.get_visibility_display }}
        </span>



        <div class="d-flex align-items-center">
            {% if is_creator %}
            <button type="button" class="button button--slim button--dark" id="openAddItemsModal">
                Add Items
            </button>
            <button type="button" class="ms-2 button button--slim button--dark" id="openModifyDetailsModal">Modify Details</button>
            <form method="post" action="{% url 'collection:delete' collection.id %}" class="ms-2" onsubmit="return confirm('Are you sure you want to delete this collection? This action cannot be undone.');">
                {% csrf_token %}
                <button type="submit" class="button button--slim button--dark btn-danger">Delete Collection</button>
            </form>
            {% endif %}
        </div>

    </div>
    {% if collection.collectionitems_set.all %}
        <!-- Search Bar -->
        <div class="search-bar mb-4">
            <input type="text" id="destinationSearch" class="form-control" placeholder="Search Collection" aria-label="Search destinations">
        </div>

        <div class="destinations-grid">
            {% for destination in collection.collectionitems_set.all %}


            
                <div class="slider-card">
                    <article class="card card--centered">
                    <div class="media media--responsive">
                        {% if destination.item.representative_image %}
                            <img src="{{ destination.item.representative_image.url }}" alt="{{ destination.item.title }}" class="img-fluid">
                        {% else %}
                            <img src="{% static 'images/placeholder.jpg' %}" alt="{{ destination.item.title }}" class="img-fluid">
                        {% endif %}
                    </div>
                    <figcaption>
                        <h3>{{ destination.item.title }}</h3>
                        <p>{{ destination.item.description }}</p>
                    </figcaption>
                    <div class="card__post-link-content">
                        <a href="{% url 'item_detail' item_title=destination.item.title %}" class="cta__link card__link__cta underline">Discover</a>
                        <p>From ${{ destination.item.price_per_night|floatformat:0 }}</p>
                        {% if is_creator %}
                        <form method="post" action="{% url 'collection:remove_item' collection.id destination.item.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                        </form>
                        {% endif %}
                    </div>
                    </article>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">
            No items have been added to this collection yet.
        </div>
    {% endif %}
</section>

{% if is_creator %}
<!-- Custom Modal for Adding Items -->
<div id="addItemsModalOverlay" class="custom-modal-overlay"></div>
<div id="addItemsModalContent" class="custom-modal" data-collection-visibility="{{ collection.visibility }}">
    <div class="custom-modal-header">
        <h5 class="custom-modal-title">Add Items to Collection</h5>
        <button type="button" class="custom-modal-close" id="closeAddItemsModal">&times;</button>
    </div>
    <form method="post" action="{% url 'collection:add_items' collection.id %}" id="addItemsForm">
        {% csrf_token %}
        <div class="custom-modal-body">
            <div class="mb-3">
                <label class="form-label">Select Items to Add</label>
                
                <!-- Display any validation errors -->
                <!-- {% if messages %}
                <div class="alert alert-warning mb-3">
                    {% for message in messages %}
                        {% if message.tags == 'error' %}
                            <p>{{ message }}</p>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %} -->
                
                <!-- Warning for private collections -->
                {% if collection.visibility == 1 %}
                <div class="alert alert-info mb-3">
                    <p><strong>Note:</strong> This is a private collection. Items added to this collection cannot exist in any other collections.</p>
                </div>
                {% endif %}
                
                <div class="items-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                    {% for item in available_items %}
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="items" value="{{ item.id }}" id="item-{{ item.id }}">
                        <label class="form-check-label" for="item-{{ item.id }}">
                            {{ item.title }} - {{ item.identifier }}
                        </label>
                    </div>
                    {% empty %}
                    <p class="text-muted">No items available to add.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="custom-modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelAddItemsModal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="submitAddItemsBtn">Add to Collection</button>
        </div>
    </form>
</div>

<!-- Custom Modal for Modifying Collection Details -->
<div id="modifyDetailsModalOverlay" class="custom-modal-overlay"></div>
<div id="modifyDetailsModalContent" class="custom-modal">
    <div class="custom-modal-header">
        <h5 class="custom-modal-title">Modify Collection Details</h5>
        <button type="button" class="custom-modal-close" id="closeModifyDetailsModal">&times;</button>
    </div>
    <form method="post" action="{% url 'collection:update' collection.id %}" id="modifyDetailsForm">
        {% csrf_token %}
        <div class="custom-modal-body">
            <div class="mb-3">
                <label for="collection-title" class="form-label">Collection Name</label>
                <input type="text" class="form-control" id="collection-title" name="title" value="{{ collection.title }}" required>
            </div>
            <div class="mb-3">
                <label for="collection-description" class="form-label">Description</label>
                <textarea class="form-control" id="collection-description" name="description" rows="4" required>{{ collection.description }}</textarea>
            </div>
        </div>
        <div class="custom-modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelModifyDetailsModal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
    </form>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add Items Modal
    const searchInput = document.getElementById('destinationSearch');
    const openAddItemsModalBtn = document.getElementById('openAddItemsModal');
    const closeAddItemsModalBtn = document.getElementById('closeAddItemsModal');
    const cancelAddItemsModalBtn = document.getElementById('cancelAddItemsModal');
    const addItemsModalOverlay = document.getElementById('addItemsModalOverlay');
    const addItemsModalContent = document.getElementById('addItemsModalContent');
    
    // Add items form submission handling
    const addItemsForm = document.getElementById('addItemsForm');
    const submitAddItemsBtn = document.getElementById('submitAddItemsBtn');
    
    // Modify Details form
    const modifyDetailsForm = document.getElementById('modifyDetailsForm');
    
    // Delete form
    const deleteCollectionForm = document.querySelector('form[action*="delete"]');
    
    // AJAX form submissions
    if (addItemsForm) {
        addItemsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const isPrivate = addItemsModalContent.dataset.collectionVisibility === "1";
            // If this is a private collection, show confirmation
            if (isPrivate) {
                const checkedItems = document.querySelectorAll('#addItemsForm input[name="items"]:checked');
                if (checkedItems.length > 0) {
                    if (!confirm("Warning: Items in this private collection cannot exist in other collections. Adding items that are already in other collections will REMOVE them from those collections and add them to this one. Continue?")) {
                        return false;
                    }
                }
            }
            
            // Submit form via AJAX
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let successMessage = data.message;
                    
                    // If items were moved from other collections
                    if (data.items_moved && data.items_moved > 0) {
                        showNotification(successMessage, 'success');
                        
                        // If both items were added and moved, display additional notification
                        if (data.items_added && data.items_added > 0) {
                            setTimeout(() => {
                                showNotification(`${data.items_moved} items were automatically moved from other collections to this private collection.`, 'info');
                            }, 1000);
                        }
                    } else {
                        showNotification(successMessage, 'success');
                    }
                    
                    closeAddItemsModal();
                    // Update page content without reload
                    updateCollectionItems();
                } else {
                    showNotification(data.message || 'Error adding items', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while processing your request', 'error');
            });
        });
    }
    
    if (modifyDetailsForm) {
        modifyDetailsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Submit form via AJAX
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message || 'Collection details updated successfully', 'success');
                    closeModifyDetailsModal();
                    // Update collection info
                    updateCollectionInfo(data.collection);
                } else {
                    showNotification(data.message || 'Error updating collection', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while processing your request', 'error');
            });
        });
    }
    
    if (deleteCollectionForm) {
        deleteCollectionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!confirm('Are you sure you want to delete this collection? This action cannot be undone.')) {
                return false;
            }
            
            // Submit form via AJAX
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message || 'Collection deleted successfully', 'success');
                    // Redirect to collections list after deletion
                    window.location.href = "{% url 'collection:list' %}";
                } else {
                    showNotification(data.message || 'Error deleting collection', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while processing your request', 'error');
            });
        });
    }
    
    // Remove item form handling via event delegation
    document.addEventListener('click', function(e) {
        if (e.target.matches('form[action*="remove_item"] button[type="submit"]')) {
            e.preventDefault();
            const form = e.target.closest('form');
            
            if (!confirm('Are you sure you want to remove this item from the collection?')) {
                return false;
            }
            
            // Submit form via AJAX
            const formData = new FormData(form);
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message || 'Item removed successfully', 'success');
                    // Remove the item from the DOM
                    const itemCard = e.target.closest('.slider-card');
                    if (itemCard) {
                        itemCard.remove();
                    }
                    
                    // If no items left, show empty message
                    const itemsContainer = document.querySelector('.destinations-grid');
                    if (itemsContainer && !itemsContainer.querySelector('.slider-card')) {
                        document.querySelector('.search-bar').style.display = 'none';
                        const emptyMessage = document.createElement('div');
                        emptyMessage.className = 'alert alert-info';
                        emptyMessage.innerHTML = '<p>No items have been added to this collection yet.</p>' +
                            '{% if is_creator %}<p>Click the "Add Items" button above to start adding items to your collection.</p>{% endif %}';
                        document.querySelector('section.container').appendChild(emptyMessage);
                    }
                } else {
                    showNotification(data.message || 'Error removing item', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while processing your request', 'error');
            });
        }
    });
    
    // Helper function to update collection items
    function updateCollectionItems() {
        fetch(window.location.href, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Check if there are items
            if (doc.querySelector('.destinations-grid')) {
                // If we currently don't have the grid but should
                if (!document.querySelector('.destinations-grid')) {
                    // Replace entire content with new content
                    document.querySelector('section.container').innerHTML = doc.querySelector('section.container').innerHTML;
                } else {
                    // Just update the grid
                    document.querySelector('.destinations-grid').innerHTML = doc.querySelector('.destinations-grid').innerHTML;
                    document.querySelector('.search-bar').style.display = 'block';
                }
            } else {
                // No items, show empty message
                const searchBar = document.querySelector('.search-bar');
                if (searchBar) searchBar.style.display = 'none';
                
                const grid = document.querySelector('.destinations-grid');
                if (grid) grid.remove();
                
                if (!document.querySelector('.alert.alert-info')) {
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'alert alert-info';
                    emptyMessage.innerHTML = '<p>No items have been added to this collection yet.</p>' +
                        '{% if is_creator %}<p>Click the "Add Items" button above to start adding items to your collection.</p>{% endif %}';
                    document.querySelector('section.container').appendChild(emptyMessage);
                }
            }
            
            // Re-attach event listeners
            attachEventListeners();
        })
        .catch(error => {
            console.error('Error updating collection items:', error);
        });
    }
    
    // Helper function to update collection info
    function updateCollectionInfo(collection) {
        if (collection) {
            const titleElement = document.querySelector('h2.heading-h');
            const descriptionElement = document.querySelector('#selected-collection-info p:first-child');
            const visibilityBadge = document.querySelector('.badge');
            
            if (titleElement) titleElement.textContent = collection.title;
            if (descriptionElement) descriptionElement.textContent = collection.description;
            if (visibilityBadge) {
                visibilityBadge.textContent = collection.visibility_display;
                visibilityBadge.classList.remove('bg-success', 'bg-warning');
                visibilityBadge.classList.add(collection.visibility === 0 ? 'bg-success' : 'bg-warning');
            }
        }
    }
    
    // Function to re-attach event listeners after DOM updates
    function attachEventListeners() {
        // Re-init search if needed
        const searchInput = document.getElementById('destinationSearch');
        if (searchInput) {
            searchInput.addEventListener('input', filterDestinations);
        }
    }
    
    function filterDestinations() {
        const searchTerm = searchInput.value.toLowerCase();
        const destinations = document.querySelectorAll('.destinations-grid .slider-card');
        
        destinations.forEach(dest => {
            const title = dest.querySelector('h3').textContent.toLowerCase();
            const description = dest.querySelector('p').textContent.toLowerCase();
            const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
            
            dest.style.display = matchesSearch ? 'block' : 'none';
        });
    }
    
    // Add search input event listener
    if (searchInput) {
        searchInput.addEventListener('input', filterDestinations);
    }

    function openAddItemsModal() {
        addItemsModalOverlay.style.display = 'block';
        addItemsModalContent.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
    }
    
    function closeAddItemsModal() {
        addItemsModalOverlay.style.display = 'none';
        addItemsModalContent.style.display = 'none';
        document.body.style.overflow = ''; // Enable scrolling again
    }
    
    openAddItemsModalBtn.addEventListener('click', openAddItemsModal);
    closeAddItemsModalBtn.addEventListener('click', closeAddItemsModal);
    cancelAddItemsModalBtn.addEventListener('click', closeAddItemsModal);
    
    // Close when clicking outside the modal
    addItemsModalOverlay.addEventListener('click', function(e) {
        if (e.target === addItemsModalOverlay) {
            closeAddItemsModal();
        }
    });

    // Modify Details Modal
    const openModifyDetailsModalBtn = document.getElementById('openModifyDetailsModal');
    const closeModifyDetailsModalBtn = document.getElementById('closeModifyDetailsModal');
    const cancelModifyDetailsModalBtn = document.getElementById('cancelModifyDetailsModal');
    const modifyDetailsModalOverlay = document.getElementById('modifyDetailsModalOverlay');
    const modifyDetailsModalContent = document.getElementById('modifyDetailsModalContent');
    
    function openModifyDetailsModal() {
        modifyDetailsModalOverlay.style.display = 'block';
        modifyDetailsModalContent.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
    
    function closeModifyDetailsModal() {
        modifyDetailsModalOverlay.style.display = 'none';
        modifyDetailsModalContent.style.display = 'none';
        document.body.style.overflow = '';
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element if it doesn't exist
        let notification = document.getElementById('notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'notification';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.padding = '10px 15px';
            notification.style.borderRadius = '4px';
            notification.style.color = 'white';
            notification.style.zIndex = '9999';
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s ease-in-out';
            document.body.appendChild(notification);
        }
        
        // Set style based on type
        if (type === 'success') {
            notification.style.backgroundColor = '#28a745';
        } else if (type === 'error') {
            notification.style.backgroundColor = '#dc3545';
        } else {
            notification.style.backgroundColor = '#17a2b8';
        }
        
        // Set message and show
        notification.textContent = message;
        notification.style.opacity = '1';
        
        // Hide after 3 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
        }, 3000);
    }
    
    openModifyDetailsModalBtn.addEventListener('click', openModifyDetailsModal);
    closeModifyDetailsModalBtn.addEventListener('click', closeModifyDetailsModal);
    cancelModifyDetailsModalBtn.addEventListener('click', closeModifyDetailsModal);
    
    modifyDetailsModalOverlay.addEventListener('click', function(e) {
        if (e.target === modifyDetailsModalOverlay) {
            closeModifyDetailsModal();
        }
    });
    
    // Close all modals when ESC key is pressed
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAddItemsModal();
            closeModifyDetailsModal();
        }
    });
});
</script>
{% endblock %}
{% endif %}
{% endblock %} 