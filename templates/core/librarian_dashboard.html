{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 1rem 0;
    border-bottom: 1px solid #dad9d7;
  }
  
  .filter-bar button {
    background: none;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 0.875rem;
    letter-spacing: 0.1rem;
    text-transform: uppercase;
    color: #9D5248;
    opacity: 0.7;
    transition: opacity 0.3s;
  }
  
  .filter-bar button.active {
    opacity: 1;
    border-bottom: 1px solid #9D5248;
  }

  /* Action buttons styling */
  .action-btn {
    background: #9D5248;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 0.875rem;
    letter-spacing: 0.1rem;
    text-transform: uppercase;
    color: #9D5248;
    opacity: 0.7;
    transition: all 0.3s;
    text-decoration: none;
  }

  .action-btn:hover {
    opacity: 1;
    text-decoration: underline;
  }

  .action-btn.btn-success {
    color: #eee;
  }

  .action-btn.btn-danger {
    color: #eee;
  }

  .action-btn.btn-info {
    color: #eee;
  }

  .action-btn.btn-primary {
    color: #eee;
  }

  .action-btn.btn-warning {
    color: #eee;
  }

  /* Status badge styling */
  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    /* border-radius: 0.25rem; */
    text-transform: uppercase;
    letter-spacing: 0.05rem;
  }

  .status-badge.bg-success {
    background-color: rgba(167, 204, 176, 0.1);
    color: #fff;
  }

  .status-badge.bg-warning {
    background-color: rgba(255, 193, 7, 0.1);
    color: #111;
  }

  .status-badge.bg-danger {
    background-color: rgba(220, 53, 69, 0.1);
    color: #eee;
  }

  .status-badge.bg-secondary {
    background-color: rgba(108, 117, 125, 0.1);
    color: #eee;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    {% csrf_token %}
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Librarian Dashboard</h1>
            <!-- Navigation Menu -->
            <div class="filter-bar">
                <button class="active" data-section="items">Items</button>
                <button data-section="collections">Collections</button>
                <button data-section="users">Users</button>
            </div>
        </div>
    </div>

    <!-- Items Section -->
    <div class="row mb-5 dashboard-section" id="items-section">
        <div class="col-12">
            <h2 class="mb-3">Items</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Identifier</th>
                            <th>Status</th>
                            <th>Location</th>
                            <th>Created By</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td>{{ item.title }}</td>
                            <td>{{ item.identifier }}</td>
                            <td>
                                <span class="status-badge {% if item.status == 0 %}bg-success{% elif item.status == 1 %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ item.get_status_display }}
                                </span>
                            </td>
                            <td>{{ item.location }}</td>
                            <td>{{ item.created_by.username|default:"Unknown" }}</td>
                            <td>{{ item.created_at|date:"Y-m-d" }}</td>
                            <td>
                                <a href="{% url 'item_detail' item.title %}" class="action-btn btn-info">View</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">No items found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loans Section -->
    <div class="row mb-5 dashboard-section" id="items-section" style="display: none;">
        <div class="col-12">
            <h2 class="mb-3">Loans</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Borrower</th>
                            <th>Status</th>
                            <th>Due Date</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Check-in Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for loan in loans %}
                        <tr>
                            <td>{{ loan.item.title }}</td>
                            <td>{{ loan.requester.username }}</td>
                            <td>
                                <span class="status-badge {% if loan.status == 1 %}bg-success{% elif loan.status == 2 %}bg-danger{% elif loan.status == 3 %}bg-secondary{% else %}bg-warning{% endif %}">
                                    {{ loan.get_status_display }}
                                </span>
                            </td>
                            <td>{{ loan.due_date|date:"Y-m-d"|default:"-" }}</td>
                            <td>{{ loan.start_date|date:"Y-m-d"|default:"-" }}</td>
                            <td>{{ loan.end_date|date:"Y-m-d"|default:"-" }}</td>
                            <td>{{ loan.end_date|date:"Y-m-d"|default:"-" }}</td>
                            <td>
                                {% if loan.status == 0 %}
                                <button class="action-btn btn-success approve-loan-btn" data-loan-id="{{ loan.id }}">Approve</button>
                                <button class="action-btn btn-danger delete-loan-btn" data-loan-id="{{ loan.id }}">Delete</button>
                                {% elif loan.status == 1 %}
                                <button class="action-btn btn-primary return-btn" data-loan-id="{{ loan.id }}">Return</button>
                                <button class="action-btn btn-danger delete-loan-btn" data-loan-id="{{ loan.id }}">Delete</button>
                                {% else %}
                                <button class="action-btn btn-danger delete-loan-btn" data-loan-id="{{ loan.id }}">Delete</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">No loans found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Collections Section -->
    <div class="row dashboard-section" id="collections-section" style="display: none;">
        <div class="col-12">
            <h2 class="mb-3">Collections</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Visibility</th>
                            <th>Creator</th>
                            <th>Created At</th>
                            <th>Items</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for collection in collections %}
                        <tr>
                            <td>{{ collection.title }}</td>
                            <td>{{ collection.description|truncatewords:20 }}</td>
                            <td>
                                <span class="status-badge {% if collection.visibility == 0 %}bg-success{% else %}bg-warning{% endif %}">
                                    {{ collection.get_visibility_display }}
                                </span>
                            </td>
                            <td>{{ collection.creator.username }}</td>
                            <td>{{ collection.created_at|date:"Y-m-d" }}</td>
                            <td>
                                {% if collection.collectionitems_set.all %}
                                    {% for collection_item in collection.collectionitems_set.all %}
                                        {{ collection_item.item.title }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">No items</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'collection:list' %}" class="action-btn btn-primary">View</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">No collections found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Access Requests Section -->
    <div class="row mb-5 dashboard-section" id="collections-section" style="display: none;">
        <div class="col-12">
            <h2 class="mb-3">Access Requests</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Collection</th>
                            <th>Status</th>
                            <th>Request Date</th>
                            <th>Reason</th>
                            <th>Reviewed By</th>
                            <th>Review Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in access_requests %}
                        <tr>
                            <td>{{ request.user.username }}</td>
                            <td>{{ request.collection.title }}</td>
                            <td>
                                <span class="status-badge {% if request.status == 'pending' %}bg-warning{% elif request.status == 'approved' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ request.get_status_display }}
                                </span>
                            </td>
                            <td>{{ request.request_date|date:"Y-m-d" }}</td>
                            <td>{{ request.reason|truncatewords:10 }}</td>
                            <td>{{ request.reviewed_by.username|default:"-" }}</td>
                            <td>{{ request.review_date|date:"Y-m-d"|default:"-" }}</td>
                            <td>
                                {% if request.status == 'pending' %}
                                <button class="action-btn btn-success approve-btn" data-request-id="{{ request.id }}">Approve</button>
                                <button class="action-btn btn-danger deny-btn" data-request-id="{{ request.id }}">Deny</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">No access requests found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Users Section -->
    <div class="row mb-5 dashboard-section" id="users-section" style="display: none;">
        <div class="col-12">
            <h2 class="mb-3">Users</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Date Joined</th>
                            <th>Last Login</th>
                            <th>Is Staff</th>
                            <th>Is Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.first_name }}</td>
                            <td>{{ user.last_name }}</td>
                            <td>{{ user.date_joined|date:"Y-m-d" }}</td>
                            <td>{{ user.last_login|date:"Y-m-d H:i"|default:"Never" }}</td>
                            <td>
                                <span class="status-badge {% if user.role == 1 %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ user.role|yesno:"Librarian,Patron" }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge {% if user.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ user.is_active|yesno:"Yes,No" }}
                                </span>
                            </td>
                            <td>
                                <a href="{% url 'accounts:user_profile' user.username %}" class="action-btn btn-info">View</a>
                                <button class="action-btn {% if user.role == 0 %}btn-success{% else %}btn-warning{% endif %} toggle-role-btn" 
                                        data-user-id="{{ user.id }}"
                                        data-current-role="{{ user.role }}">
                                    {% if user.role == 0 %}Make Librarian{% else %}Make Patron{% endif %}
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">No users found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle section navigation
    const filterButtons = document.querySelectorAll('.filter-bar button');
    const sections = document.querySelectorAll('.dashboard-section');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update active state of buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Show/hide sections
            const targetSection = this.dataset.section;
            sections.forEach(section => {
                if (section.id === `${targetSection}-section`) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        });
    });

    // Handle approve/deny buttons
    const approveButtons = document.querySelectorAll('.approve-btn');
    const denyButtons = document.querySelectorAll('.deny-btn');
    
    function handleRequest(action, requestId) {
        fetch(`/access-request/${action}/${requestId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'An error occurred');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing the request');
        });
    }
    
    approveButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Are you sure you want to approve this request?')) {
                handleRequest('approve', this.dataset.requestId);
            }
        });
    });
    
    denyButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Are you sure you want to deny this request?')) {
                handleRequest('deny', this.dataset.requestId);
            }
        });
    });

    // Handle loan actions
    const approveLoanButtons = document.querySelectorAll('.approve-loan-btn');
    const deleteLoanButtons = document.querySelectorAll('.delete-loan-btn');
    const returnButtons = document.querySelectorAll('.return-btn');
    
    function handleLoanAction(action, loanId) {
        fetch(`/loan/${action}/${loanId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'An error occurred');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing the request');
        });
    }
    
    approveLoanButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Are you sure you want to approve this loan?')) {
                handleLoanAction('approve', this.dataset.loanId);
            }
        });
    });
    
    deleteLoanButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this loan? This action cannot be undone.')) {
                handleLoanAction('delete', this.dataset.loanId);
            }
        });
    });
    
    returnButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Are you sure you want to mark this item as returned?')) {
                handleLoanAction('return', this.dataset.loanId);
            }
        });
    });

    // Handle role toggle buttons
    const toggleRoleButtons = document.querySelectorAll('.toggle-role-btn');
    
    toggleRoleButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const currentRole = parseInt(this.dataset.currentRole);
            const newRole = currentRole === 0 ? 1 : 0;
            const action = currentRole === 0 ? 'make librarian' : 'make patron';
            
            if (confirm(`Are you sure you want to ${action}?`)) {
                fetch(`/accounts/toggle-role/${userId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        new_role: newRole
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || 'An error occurred');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while processing the request');
                });
            }
        });
    });
});
</script>
{% endblock %} 