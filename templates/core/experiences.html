{% extends "base.html" %}
{% load static %}

{% block title %}Experiences | Hootel Resorts, Hotels &amp; Residences{% endblock %}

{% block extra_css %}
<style>
  /* Additional styles specific to the experiences page */
  
  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  
  .modal-content {
    background-color: #F7F5F1;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    text-align: center;
    border-radius: 5px;
  }
  
  .modal-content h3 {
    margin-bottom: 1rem;
  }
  
  .modal-content p {
    margin-bottom: 1.5rem;
  }
  
  .modal-content button {
    background-color: #9D5248;
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }
  
  .modal-content button:hover {
    background-color: #1a1a1a;
  }
  
  /* Selected Collection Info styles */
  .selected-collection-info {
    max-width: 800px;
    margin: 2rem 0;
    padding: 1.5rem;
    background-color: #F7F5F1;
    border-left: 3px solid #9D5248;
  }
  
  .selected-collection-info h3 {
    color: #9D5248;
    margin-bottom: 0.5rem;
  }
  
  .selected-collection-info p {
    margin-bottom: 0;
    line-height: 1.6;
  }
  
  .experience-hero {
    position: relative;
    height: 600px;
    overflow: hidden;
    margin-bottom: 3rem;
  }
  
  .experience-hero img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .slider-card .card__post-link-content {
    padding: 1rem;
    border-top: 1px solid #dad9d7;
  }
  
  .experience-hero-content {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 4rem 2rem 2rem;
    background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
    color: #F7F5F1;
  }
  
  .experience-detail {
    padding: 4rem 0;
  }
  
  .experience-detail:nth-child(even) {
    background-color: #F7F5F1;
  }
  
  .experience-image {
    position: relative;
    height: 100%;
    min-height: 400px;
  }
  
  .experience-image img {
    position: absolute;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .experience-content {
    padding: 2rem;
  }
  
  @media (max-width: 768px) {
    .experience-hero {
      height: 300px;
    }
    
    .experience-image {
      min-height: 300px;
    }
  }

  /* Content area and curtain styles */
  .content-area {
    position: relative;
    min-height: 400px; /* Ensure there's space even if no content */
  }
  
  .content-curtain {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(1px);
    background: linear-gradient(to bottom, 
                               rgba(255, 255, 255, 0) 0%, 
                               rgba(255, 255, 255, 0.5) 5%, 
                               rgba(255, 255, 255, 0.5) 95%, 
                               rgba(255, 255, 255, 0) 100%);
    z-index: 100;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    text-align: center;
    padding-top: 10rem;
  }

  .content-curtain h3 {
    margin-bottom: 1rem;
    color: #9D5248;
  }

  .content-curtain p {
    margin-bottom: 2rem;
  }

  .content-curtain .button {
    background-color: #9D5248;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 3px;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
  }

  .content-curtain .button:hover {
    background-color: #8a453c;
  }

  .destinations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 3rem;
    min-height: 1000px;
  }

  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 1rem 0;
    border-bottom: 1px solid #dad9d7;
  }
  
  .filter-bar button {
    background: none;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 0.875rem;
    letter-spacing: 0.1rem;
    text-transform: uppercase;
    color: #9D5248;
    opacity: 0.7;
    transition: opacity 0.3s;
  }
  
  .filter-bar button.active {
    opacity: 1;
    border-bottom: 1px solid #9D5248;
  }
  
  /* Search Bar Styles */
  .search-bar {
    max-width: 500px;
    margin: 0;
  }
  
  .search-bar input {
    padding: 0.75rem 1rem;
    border: none;
    border-bottom: 1px solid #dad9d7;
    border-radius: 0;
    font-size: 1rem;
    width: 100%;
    background: transparent;
  }
  
  .search-bar input:focus {
    outline: none;
    border-color: #9D5248;
  }
  
  /* Ensure consistent image dimensions in destination cards */
  .slider-card {
    height: 100%;
  }
  
  .media--responsive {
    height: 250px;
    overflow: hidden;
  }
  
  .slider-card .media--responsive img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }
  
  .slider-card .media--responsive img:hover {
    transform: scale(1.05);
  }

  .slider-card figcaption {
    flex: 1;
    padding: 1rem;
  }
  
  .slider-card figcaption p {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 1rem;
  }

  .slider-card .card__post-link-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background-color: var(--color-background);
    border-top: 1px solid var(--color-border);
  }
  
  .card__link__cta {
    color: var(--color-text);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
  }
  
  .card__link__cta:hover {
    color: var(--color-primary);
  }
  
  .card__post-link-content p {
    margin: 0;
    color: var(--color-text);
    font-weight: 500;
  }
  
  @media (max-width: 768px) {
    .destination-hero {
      height: 300px;
    }
  }
  
  /* Banner Section Styles */
  .banner-section {
    position: relative;
    overflow: hidden;
  }
  
  .banner-section img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    min-height: 400px;
  }
  
  .banner-section .col-md-6 {
    padding: 0;
  }
  
  .banner-section .col-md-6:first-child {
    position: relative;
  }
  
  .banner-section .col-md-6:last-child {
    padding: 2rem;
  }

  /* Express Interest button styles */
  .express-interest-btn {
    background: none;
    border: none;
    padding: 0;
    font: inherit;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
  }
  
  .express-interest-btn:hover {
    text-decoration: underline;
  }

</style>
{% endblock %}

{% block content %}
<!-- Hero Banner -->
<section class="destination-hero">
  <video autoplay muted loop class="w-100">
    <source src="{% static 'videos/experiences-hero.mp4' %}" type="video/mp4">
    Your browser does not support the video tag.
  </video>
</section>

<!-- Intro Section -->
<section class="container container--spacer gutter">
  <header class="hgroup hgroup--limited text--centered">
    <p class="subtitle">Experiences at Hootel</p>
    <h2 class="heading-h">The Premier Exclusive Experience</h2>
    <div class="hgroup__intro">
      <p>From spiritual pilgrimages to cultural discoveries, Hootel curates transformative experiences that immerse guests in the spirit of each destination. Each Hootel property offers its own selection of activities that celebrate the surrounding landscape and culture.</p>
    </div>
    <div class="hgroup__intro">
      <p>Experiences are curated by Hootel's team and are <strong><u>invite-only</u></strong>. If you'd like to be added to the list of authorized users, please request access.</p>

      </div>
  </header>



  <!-- Filter Bar -->
  <div class="filter-bar">
    <!-- <button class="active" data-filter="none">Select a Collection</button> -->
    {% for collection in collections %}
      {% if collection.visibility == 1 %}
        <button data-filter="collection-{{ collection.id }}" 
                data-authorized="{{ collection.is_authorized|yesno:"true,false" }}"
                data-title="{{ collection.title }}"
                data-description="{{ collection.description }}">{{ collection.title }}</button>
      {% endif %}
    {% endfor %}
  </div>

  <!-- Selected Collection Info -->
  <div id="selected-collection-info" class="selected-collection-info mb-4" style="display: none;">
    <h3 id="collection-title" class="heading-h--small mb-2"></h3>
    <p id="collection-description" class="mb-3"></p>
  </div>

  <!-- Search Bar -->
  <div class="search-bar mb-4">
    <input type="text" id="destinationSearch" class="form-control" placeholder="Search destinations..." aria-label="Search destinations">
  </div>
</section>

<!-- Content area that can be blurred -->
<div class="content-area">
  <!-- Content curtain that will cover the entire content area -->
  <div id="content-curtain" class="content-curtain" style="display: none;">
    <h3>Exclusive Content</h3>
    <p>You need to be authorized to view this exclusive collection.</p>
    <button class="button request-access-btn">Request Access</button>
  </div>
    
  <!-- Destinations Grid -->
  <section class="container container--spacer gutter">
    <div class="destinations-grid" style="display: none;">
      {% for destination in destinations %}
      <div class="slider-card" data-region="{{ destination.region }}" data-collections="{{ destination.collection_ids|join:',' }}">
        <article class="card card--centered">
          <div class="media media--responsive">
            {% if destination.representative_image %}
              <img src="{{ destination.representative_image }}" alt="{{ destination.name }}" class="img-fluid">
            {% else %}
              <img src="{% static 'images/placeholder.jpg' %}" alt="{{ destination.name }}" class="img-fluid">
            {% endif %}
          </div>
          <figcaption>
            <h3>{{ destination.name }}</h3>
            <p>{{ destination.description }}</p>
          </figcaption>
          <div class="card__post-link-content">
            <a href="{% url 'item_detail' item_title=destination.name %}" class="cta__link card__link__cta underline">Discover</a>
            <p>From ${{ destination.price|floatformat:2 }}</p>
          </div>
        </article>
      </div>
      {% endfor %}
    </div>
  </section>
</div>

  <!-- Banner Section -->
  <section class="container container--spacer gutter bg-white banner-section">
    <div class="row">
      <div class="col-md-6">
        <img src="{% static 'core/images/destination-feature.jpg' %}" alt="Hootel Experience" class="img-fluid">
      </div>
      <div class="col-md-6 d-flex align-items-center">
        <div class="px-4 py-5">
          <p class="subtitle">The Classic Hootel Experience</p>
          <h2 class="heading-h">First-Class Luxury</h2>
          <p>Explore our regular collection of experiences, available to all Hootel guests.</p>
          <a href="/destinations/" class="button button--dark mt-4">Explore Destinations</a>
        </div>
      </div>
    </div>
  </section>

<!-- Request Modal -->
<div id="requestModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Access Request</h3>
    <p id="modalMessage"></p>
    <button id="closeModal">Close</button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Destinations page specific JavaScript
  document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('destinationSearch');
    const filterButtons = document.querySelectorAll('.filter-bar button');
    const destinations = document.querySelectorAll('.destinations-grid .slider-card');
    const destinationsGrid = document.querySelector('.destinations-grid');
    const contentCurtain = document.getElementById('content-curtain');
    const contentArea = document.querySelector('.content-area');
    const selectedCollectionInfo = document.getElementById('selected-collection-info');
    const collectionTitle = document.getElementById('collection-title');
    const collectionDescription = document.getElementById('collection-description');
    let currentCollectionId = null;
    
    function filterDestinations() {
      const searchTerm = searchInput.value.toLowerCase();
      const activeFilterButton = document.querySelector('.filter-bar button.active');
      if (!activeFilterButton) return;
      
      const activeFilter = activeFilterButton.getAttribute('data-filter');
      const isAuthorized = activeFilterButton.getAttribute('data-authorized') === 'true';
      
      // Get and display collection info
      const collectionTitleText = activeFilterButton.getAttribute('data-title');
      const collectionDescText = activeFilterButton.getAttribute('data-description');
      
      if (collectionTitleText) {
        collectionTitle.textContent = collectionTitleText;
        collectionDescription.textContent = collectionDescText || 'No description available';
        selectedCollectionInfo.style.display = 'block';
      } else {
        selectedCollectionInfo.style.display = 'none';
      }
      
      // Hide grid if no collection is selected
      if (activeFilter === 'none') {
        destinationsGrid.style.display = 'none';
        return;
      }
      
      // Show grid if a collection is selected
      destinationsGrid.style.display = 'grid';
      
      // Show/hide content curtain based on authorization
      if (isAuthorized) {
        contentCurtain.style.display = 'none';
      } else {
        contentCurtain.style.display = 'flex';
        if (activeFilter.startsWith('collection-')) {
          currentCollectionId = activeFilter.split('-')[1];
        }
      }
      
      destinations.forEach(dest => {
        const title = dest.querySelector('h3').textContent.toLowerCase();
        const description = dest.querySelector('p').textContent.toLowerCase();
        const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
        
        let matchesFilter = true;
        if (activeFilter !== 'all') {
          if (activeFilter.startsWith('collection-')) {
            const collectionId = activeFilter.split('-')[1];
            const collections = dest.getAttribute('data-collections').split(',');
            matchesFilter = collections.includes(collectionId);
          } else {
            matchesFilter = dest.getAttribute('data-region') === activeFilter;
          }
        }
        
        dest.style.display = matchesSearch && matchesFilter ? 'block' : 'none';
      });
    }
    
    // Add search input event listener
    searchInput.addEventListener('input', filterDestinations);
    
    // Filter functionality
    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        // Update active button
        filterButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        // Filter destinations
        filterDestinations();
      });
    });

    // Access Request functionality
    const expressInterestBtns = document.querySelectorAll('.express-interest-btn');
    const requestAccessBtn = document.querySelector('.request-access-btn');
    const modal = document.getElementById('requestModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const closeModal = document.getElementById('closeModal');
    
    if (requestAccessBtn) {
      requestAccessBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        
        if (!currentCollectionId) {
          modalTitle.textContent = 'Error';
          modalMessage.textContent = 'Please select a collection first.';
          modal.style.display = 'block';
          return;
        }
        
        try {
          const response = await fetch('/access-request/create/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: `collection_id=${currentCollectionId}&reason=Requesting access to exclusive collection`
          });
          
          const data = await response.json();
          
          modalTitle.textContent = data.success ? 'Success' : 'Error';
          modalMessage.textContent = data.message;
          modal.style.display = 'block';
          
        } catch (error) {
          modalTitle.textContent = 'Error';
          modalMessage.textContent = 'An error occurred while submitting your request. Please try again.';
          modal.style.display = 'block';
        }
      });
    }
    
    expressInterestBtns.forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.preventDefault(); // Prevent default link behavior
        const collectionId = this.getAttribute('data-collection-id');
        const destinationName = this.getAttribute('data-destination-name');
        
        try {
          const response = await fetch('/access-request/create/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: `collection_id=${collectionId}&reason=Requesting access to ${destinationName}`
          });
          
          const data = await response.json();
          
          modalTitle.textContent = data.success ? 'Success' : 'Error';
          modalMessage.textContent = data.message;
          modal.style.display = 'block';
          
        } catch (error) {
          modalTitle.textContent = 'Error';
          modalMessage.textContent = 'An error occurred while submitting your request. Please try again.';
          modal.style.display = 'block';
        }
      });
    });
    
    // Close modal when clicking the close button
    closeModal.addEventListener('click', function() {
      modal.style.display = 'none';
    });
    
    // Close modal when clicking outside the modal content
    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });
    
    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    // Select first button by default to initialize the view
    if (filterButtons.length > 0) {
      filterButtons[0].click();
    }
  });
</script>
{% endblock %} 