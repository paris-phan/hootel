{% extends base_template %}
{% load static %}
{% load socialaccount %}

{% block title %}Patron Home - HotelManager6000{% endblock %}

{% block content %}
<style>
  body {
    background: url("{% static 'images/hotel1.jpg' %}") no-repeat center center fixed;
    background-size: cover;
  }

  .frosted-glass {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    padding: 2.5rem;
    color: white;
  }

  .profile-pic-wrapper {
    width: 150px;
    height: 150px;
    margin: 0 auto 1rem auto;
    position: relative;
    overflow: hidden;
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    cursor: pointer;
  }

  .profile-pic-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease;
  }

  .profile-pic-overlay {
    position: absolute;
    bottom: 0;
    width: 100%;
    background-color: rgba(0,0,0,0.5);
    color: white;
    font-size: 12px;
    text-align: center;
    padding: 6px 0;
  }

  .btn-custom {
    border-radius: 30px;
    font-weight: 500;
    padding: 0.75rem;
  }

  .info-label {
    color: #f8f9fa;
    font-weight: 500;
  }

  .container-min-height {
    min-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>

<div class="container container-min-height">
  <div class="col-md-10 col-lg-6">
    <div class="frosted-glass text-center">
      <h2 class="mb-4">üëã Welcome, {{ name }}!</h2>

      <form id="profilePictureForm" method="post" enctype="multipart/form-data" style="display: none;">
        {% csrf_token %}
        <input type="file" id="profilePictureInput" name="profile_picture" accept="image/*">
      </form>

      <div id="profilePictureContainer" class="profile-pic-wrapper">
        <img id="profileImage" src="{{ profile_picture_url }}" alt="Profile Picture">
        <div class="profile-pic-overlay">Click to change</div>
      </div>

      <div class="text-start mt-4 mb-4" style="max-width: 320px; margin: 0 auto;">
        <p><span class="info-label">Name:</span> {{ name }}</p>
        <p><span class="info-label">Email:</span> {{ email }}</p>
        <p><span class="info-label">Account Type:</span> {{ user_type }}</p>
      </div>

      <div class="d-grid gap-3 mt-4">
        <a href="{% url 'patron:my_bookings' %}" class="btn btn-info btn-custom text-white">
          üìî My Bookings
        </a>
        <a href="{% url 'patron:search' %}" class="btn btn-primary btn-custom">
          üîç Search Hotels
        </a>
        <a href="{% url 'logout' %}" class="btn btn-danger btn-custom">
          üîì Logout
        </a>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const profilePictureContainer = document.getElementById('profilePictureContainer');
    const profilePictureInput = document.getElementById('profilePictureInput');
    const profilePictureForm = document.getElementById('profilePictureForm');
    const profileImage = document.getElementById('profileImage');
    
    profilePictureContainer.addEventListener('click', function() {
        profilePictureInput.click();
    });
    
    profilePictureInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            profileImage.style.opacity = '0.5';
            const formData = new FormData(profilePictureForm);

            fetch('{% url "update_profile_picture" %}', {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    profileImage.src = data.image_url + '?t=' + new Date().getTime();
                } else {
                    alert('Failed to upload image: ' + data.error);
                }
                profileImage.style.opacity = '1';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while uploading the image.');
                profileImage.style.opacity = '1';
            });
        }
    });
});
</script>
{% endblock %}
