{% extends 'base.html' %}
{% load static %}

{% block title %}{{ user.get_full_name|default:user.username }} - Hootel{% endblock %}

{% block extra_css %}
<style>
/* Custom modal styles */
.custom-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 2000;
}

.custom-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border-radius: 5px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    width: 80%;
    max-width: 800px;
    z-index: 2001;
}

.custom-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
}

.custom-modal-title {
    margin: 0;
    font-size: 1.25rem;
}

.custom-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    margin-left: 15px;
}

.custom-modal-body {
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
}

.custom-modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h4 mb-0">@{{ user.username }}</h2>
                    {% if is_own_profile %}
                    <form method="post" action="{% url 'account_logout' %}">
                        {% csrf_token %}
                        <button type="submit" class="button button--slim button--dark">Logout</button>
                    </form>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-4 text-center">
                            <div class="profile-avatar mb-3">
                                {% if user.profile_picture %}
                                    <img src="{{ user.profile_picture.url }}" alt="Profile Picture" class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
                                {% else %}
                                    <img src="{% static 'images/default-avatar.png' %}" alt="Default Avatar" class="rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
                                {% endif %}
                            </div>
                            {% if is_own_profile %}
                            <div class="text-center mb-4">
                                <form method="post" action="{% url 'accounts:update_profile_photo' %}" enctype="multipart/form-data" class="d-inline-block" id="profilePhotoForm">
                                    {% csrf_token %}
                                    <div class="input-group">
                                        <input type="file" name="profile_picture" class="form-control d-none" id="profilePhotoInput" accept="image/*">
                                        <button type="button" class="button button--slim button--dark" onclick="document.getElementById('profilePhotoInput').click()">Change Photo</button>
                                    </div>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <h3 class="h3">{{ user.get_full_name|default:user.username }}</h3>
                            </div>
                            <div class="mb-3">
                                <p class="h5">{{ user.email }}</p>
                            </div>
                            <div class="mb-3">
                                <span class="subtitle">{{ role_display }}</span>
                            </div>
                            {% if user.role == 1 %}
                            <div>
                                <a href="{% url 'core:librarian_dashboard' %}" class="button button--slim button--dark">Staff Portal</a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="h6 text-muted">Account Details</h4>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <strong>Username:</strong>
                                    <span class="float-end">{{ user.username }}</span>
                                </li>
                                <li class="mb-2">
                                    <strong>Date Joined:</strong>
                                    <span class="float-end">{{ user.date_joined|date:"F j, Y" }}</span>
                                </li>
                                {% if is_own_profile %}
                                <li class="mb-2">
                                    <strong>Last Login:</strong>
                                    <span class="float-end">{{ user.last_login|date:"F j, Y" }}</span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h4 class="h6 text-muted">Contact Information</h4>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <strong>Email:</strong>
                                    <span class="float-end">{{ user.email }}</span>
                                </li>
                                {% if user.first_name %}
                                <li class="mb-2">
                                    <strong>First Name:</strong>
                                    <span class="float-end">{{ user.first_name }}</span>
                                </li>
                                {% endif %}
                                {% if user.last_name %}
                                <li class="mb-2">
                                    <strong>Last Name:</strong>
                                    <span class="float-end">{{ user.last_name }}</span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loans Section -->
    <div class="row justify-content-center mt-5">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h2 class="h4 mb-0">Current Bookings</h2>
                </div>
                <div class="card-body">
                    <div class="loans-list">
                        {% for loan in loans %}
                        <div class="loan-item mb-4 pb-4 {% if not forloop.last %}border-bottom{% endif %}">
                            <div class="d-flex align-items-start">
                                <div class="loan-content flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="mb-0">
                                            <a href="{% url 'catalog:item_detail' item_title=loan.item.title %}" class="text-decoration-none">
                                                {{ loan.item.title }}
                                            </a>
                                        </h5>
                                        <span class="badge {% if loan.status == 0 %}bg-warning{% elif loan.status == 1 %}bg-success{% elif loan.status == 2 %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {{ loan.get_status_display }}
                                        </span>
                                    </div>
                                    <div class="loan-details">
                                        <p class="mb-1">
                                            <strong>Requested:</strong> {{ loan.requested_at|date:"F j, Y" }}
                                        </p>
                                        {% if loan.start_date %}
                                        <p class="mb-1">
                                            <strong>Start Date:</strong> {{ loan.start_date|date:"F j, Y" }}
                                        </p>
                                        {% endif %}
                                        {% if loan.end_date %}
                                        <p class="mb-1">
                                            <strong>End Date:</strong> {{ loan.end_date|date:"F j, Y" }}
                                        </p>
                                        {% endif %}
                                        {% if loan.reservation_total %}
                                        <p class="mb-1">
                                            <strong>Total:</strong> ${{ loan.reservation_total }}
                                        </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted">No current loans.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    {% if reviews %}
    <div class="row justify-content-center mt-5">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h2 class="h4 mb-0">Reviews</h2>
                </div>
                <div class="card-body">
                    <div class="reviews-list">
                        {% for review in reviews %}
                        <div class="review-item mb-4 pb-4 {% if not forloop.last %}border-bottom{% endif %}">
                            <div class="d-flex align-items-start">
                                <div class="review-content flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="mb-0">
                                            <a href="{% url 'catalog:item_detail' item_title=review.item.title %}" class="text-decoration-none">
                                                {{ review.item.title }}
                                            </a>
                                        </h5>
                                        <div class="rating">
                                            {% for i in "12345"|make_list %}
                                                {% if forloop.counter <= review.rating %}
                                                    <span class="text-black">☆</span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <p class="review-text mb-2">{{ review.comment }}</p>
                                    <small class="text-muted">{{ review.created_at|date:"F j, Y" }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Collections Section -->
    <div class="row justify-content-center mt-5">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h2 class="h4 mb-0">Collections</h2>
                    {% if is_own_profile %}
                    <button type="button" class="button button--slim button--dark" id="openCreateCollectionModal">
                        Create Collection
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for collection in user.collections_created.all %}
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <a href="{% url 'collection:detail' collection.id %}" class="text-decoration-none">
                                            {{ collection.title }}
                                        </a>
                                    </h5>
                                    <p class="card-text">{{ collection.description|truncatewords:30 }}</p>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            Visibility: {{ collection.get_visibility_display }}
                                        </small>
                                    </p>
                                    {% if collection.collectionitems_set.all %}
                                        <h6>Items in this collection:</h6>
                                        <ul class="list-unstyled">
                                            {% for item in collection.collectionitems_set.all %}
                                                <li>{{ item.item.title }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted">No items in this collection.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <p class="text-muted">No collections created yet.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if is_own_profile %}
<!-- Custom Modal Implementation -->
<div id="createCollectionModalOverlay" class="custom-modal-overlay"></div>
<div id="createCollectionModalContent" class="custom-modal">
    <div class="custom-modal-header">
        <h5 class="custom-modal-title">Create New Collection</h5>
        <button type="button" class="custom-modal-close" id="closeCreateCollectionModal">&times;</button>
    </div>
    <form method="post" action="{% url 'collection:create' %}" id="createCollectionForm">
        {% csrf_token %}
        <div class="custom-modal-body">
            <div class="mb-3">
                <label for="collection-title" class="form-label">Collection Title</label>
                <input type="text" class="form-control" id="collection-title" name="title" required>
            </div>
            <div class="mb-3">
                <label for="collection-description" class="form-label">Description</label>
                <textarea class="form-control" id="collection-description" name="description" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label for="collection-visibility" class="form-label">Visibility</label>
                <select class="form-select" id="collection-visibility" name="visibility">
                    <option value="0">Public</option>
                    {% if user.role == 1 %}
                    <option value="1">Private</option>
                    {% endif %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Select Items</label>
                <div class="items-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                    {% for item in all_items %}
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="items" value="{{ item.id }}" id="item-{{ item.id }}">
                        <label class="form-check-label" for="item-{{ item.id }}">
                            {{ item.title }} - {{ item.identifier }}
                        </label>
                    </div>
                    {% empty %}
                    <p class="text-muted">No items available.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="custom-modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelCreateCollectionModal">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Collection</button>
        </div>
    </form>
</div>
{% endif %}

{% if is_own_profile %}
{% block extra_js %}
<script>
document.getElementById('profilePhotoInput').addEventListener('change', function(e) {
    if (this.files && this.files[0]) {
        // Validate file type
        const file = this.files[0];
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size should be less than 5MB.');
            return;
        }
        
        // Submit the form
        document.getElementById('profilePhotoForm').submit();
    }
});

// Custom modal functionality
document.addEventListener('DOMContentLoaded', function() {
    const openModalBtn = document.getElementById('openCreateCollectionModal');
    const closeModalBtn = document.getElementById('closeCreateCollectionModal');
    const cancelModalBtn = document.getElementById('cancelCreateCollectionModal');
    const modalOverlay = document.getElementById('createCollectionModalOverlay');
    const modalContent = document.getElementById('createCollectionModalContent');
    
    function openModal() {
        modalOverlay.style.display = 'block';
        modalContent.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
    }
    
    function closeModal() {
        modalOverlay.style.display = 'none';
        modalContent.style.display = 'none';
        document.body.style.overflow = ''; // Enable scrolling again
    }
    
    openModalBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    cancelModalBtn.addEventListener('click', closeModal);
    
    // Close when clicking outside the modal
    modalOverlay.addEventListener('click', function(e) {
        if (e.target === modalOverlay) {
            closeModal();
        }
    });
    
    // Close when ESC key is pressed
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
});
</script>
{% endblock %}
{% endif %}
{% endblock %} 