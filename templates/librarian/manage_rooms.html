{% extends "base/librarian_base.html" %}

{% block title %}Manage Rooms - HotelManager6000{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manage Rooms</h2>
        <div>
            <a href="{% url 'create_room' %}" class="btn btn-primary">Add New Room</a>
        </div>
    </div>

    <div class="row">
        {% for room in rooms %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                {% if user.is_staff or room.created_by == user %}
                <!-- Image upload form for staff -->
                <form id="roomImageForm-{{ room.id }}" method="post" enctype="multipart/form-data" style="display:none;">
                    {% csrf_token %}
                    <input type="file" id="roomImageInput-{{ room.id }}" name="room_image" accept="image/*">
                </form>

                <!-- Clickable image container for staff -->
                <div class="position-relative" style="cursor: pointer;"
                    data-id="{{ room.id }}"
                    onclick="document.getElementById('roomImageInput-{{ room.id }}').click();">
                    <img src="{{ room.image_url }}" class="card-img-top" alt="{{ room.name }}" style="height: 200px; object-fit: cover;">
                    <div class="position-absolute bottom-0 end-0 p-2 bg-dark bg-opacity-75 text-white rounded-start">
                        <small>Click to change image</small>
                    </div>
                </div>
                {% else %}
                <!-- Non-clickable image for non-staff -->
                <img src="{{ room.image_url }}" class="card-img-top" alt="{{ room.name }}" style="height: 200px; object-fit: cover;">
                {% endif %}

                <div class="card-body">
                    <h3 class="card-title">{{ room.name }}</h3>
                    <h5 class="card-subtitle mb-2">Room {{ room.room_number }} - Floor {{ room.floor }}</h5>
                    <p class="card-text">{{ room.description|truncatechars:100 }}</p>
                    <p><strong>Type:</strong> {{ room.room_type }}</p>
                    <p><strong>Price:</strong> ${{ room.price_per_night }}/night</p>
                    {% if room.created_by %}
                    <p class="text-muted"><small>Created by: {{ room.created_by.username }}</small></p>
                    {% endif %}
                </div>

                <div class="card-footer bg-transparent">
                    <div class="btn-group w-100">
                        <a href="{% url 'view_room' room.id %}" class="btn btn-outline-primary">View</a>
                        <a href="{% url 'update_room' room.id %}" class="btn btn-outline-secondary">Edit</a>
                        <a href="{% url 'delete_room' room.id %}" class="btn btn-outline-danger">Delete</a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                No rooms have been created yet. Click "Add New Room" to get started.
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% if user.is_staff %}
<script>
document.querySelectorAll('input[type="file"]').forEach(input => {
    input.addEventListener('change', function() {
        const form = this.closest('form');
        const roomId = form.id.split('-')[1];
        const formData = new FormData(form);
        
        fetch(`/update_room_image/${roomId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating image');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating image');
        });
    });
});
</script>
{% endif %}
{% endblock %} 